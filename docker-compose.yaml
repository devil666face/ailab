x-ollama: &ollama
  image: ghcr.io/devil666face/ollama:nvidia
  build:
    context: ollama/nvidia
    dockerfile: Dockerfile
  container_name: ollama
  hostname: ollama.ailab.lan
  restart: unless-stopped
  environment:
    OLLAMA_CONTEXT_LENGTH: 8192
    OLLAMA_FLASH_ATTENTION: 1
    OLLAMA_KV_CACHE_TYPE: q8_0
    OLLAMA_MAX_LOADED_MODELS: 2
    JUPITER_TOKEN: ${JUPITER_TOKEN}
  volumes:
    - ./data/ollama:/root/.ollama
    - ./data/files:/root/files
  networks:
    - ailab
  tty: true
  expose:
    - 80/tcp
    - 11434/tcp
  ports:
    - 127.0.0.1:11434:11434/tcp
  labels:
    - "traefik.enable=true"
    - "traefik.http.routers.jupiter.tls=true"
    - "traefik.http.routers.jupiter.rule=Host(`jupiter.ailab.lan`)"
    - "traefik.http.services.jupiter.loadbalancer.server.scheme=http"
    - "traefik.http.services.jupiter.loadbalancer.server.port=80"

services:
  traefik:
    image: traefik:latest
    container_name: traefik
    hostname: traefik.ailab.lan
    command:
      - "--api.insecure=true"
      - "--providers.docker"
      - "--serversTransport.insecureSkipVerify=true"
      - "--providers.docker.exposedByDefault=false"
      - "--entrypoints.http.address=:80"
      - "--entrypoints.https.address=:443"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--entrypoints.http.http.redirections.entrypoint.to=https"
      - "--entrypoints.http.http.redirections.entrypoint.scheme=https"
    expose:
      - 80/tcp
      - 443/tcp
    # ports:
    #   - "80:80"
    #   - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik/dynamic:/etc/traefik/dynamic
    networks:
      ailab:
        aliases:
          - traefik
          - ollama.ailab.lan
          - shell.ailab.lan
          - jupiter.ailab.lan
          - n8n.ailab.lan
          - open-webui.ailab.lan
    restart: unless-stopped

  proxy:
    container_name: proxy
    hostname: proxy.ailab.lan
    image: ghcr.io/devil666face/gox:latest
    restart: unless-stopped
    volumes:
      - ./proxy/config:/gox/config
    ports:
      - 0.0.0.0:1080:1080/tcp
    networks:
      - ailab

  postgres:
    container_name: postgres
    hostname: postgres.ailab.lan
    image: postgres:18.0-alpine3.22
    restart: unless-stopped
    environment:
      PGDATA: /data/postgres
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./data/postgres:/data/postgres
    networks:
      ailab:
        aliases:
          - postgres
          - postgres.ailab.lan

  n8n:
    container_name: n8n
    hostname: n8n.ailab.lan
    image: n8nio/n8n:latest
    build:
      context: n8n
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - 80/tcp
    environment:
      N8N_HOST: n8n.ailab.lan
      N8N_PORT: 80
      N8N_PROTOCOL: https
      NODE_ENV: production
      WEBHOOK_URL: https://n8n.ailab.lan/
      GENERIC_TIMEZONE: Europe/Moscow
      N8N_BASIC_AUTH_ACTIVE: true
      N8N_BASIC_AUTH_USER: admin
      N8N_BASIC_AUTH_PASSWORD: Qwerty123
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
      N8N_DIAGNOSTICS_ENABLED: false
      N8N_PERSONALIZATION_ENABLED: false
      N8N_RUNNERS_ENABLED: true
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB}
      DB_POSTGRESDB_USER: ${POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      N8N_SECURE_COOKIE: false
      # N8N_ENCRYPTION_KEY:
      # N8N_USER_MANAGEMENT_JWT_SECRET:
      # N8N_ENCRYPTION_KEY: a60eea2398732dcf0ad7383c688a1d3d
    volumes:
      - ./data/n8n:/root/.n8n
      - ./data/files:/files
    depends_on:
      - postgres
    networks:
      - ailab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.ailab.lan`)"
      - "traefik.http.services.n8n.loadbalancer.server.scheme=http"
      - "traefik.http.services.n8n.loadbalancer.server.port=80"

  open-webui:
    image: ghcr.io/open-webui/open-webui:latest
    container_name: open-webui
    hostname: open-webui.ailab.lan
    volumes:
      - ./data/open-webui:/app/backend/data
    expose:
      - 80/tcp
    environment:
      OLLAMA_BASE_URL: http://ollama:11434
      PORT: 80
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - ailab
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.open-webui.tls=true"
      - "traefik.http.routers.open-webui.rule=Host(`open-webui.ailab.lan`)"
      - "traefik.http.services.open-webui.loadbalancer.server.scheme=http"
      - "traefik.http.services.open-webui.loadbalancer.server.port=80"

  ollama:
    profiles: ["cpu"]
    build:
      context: ollama
      dockerfile: Dockerfile.nvidia
    <<: *ollama

  nvidia:
    profiles: ["nvidia"]
    <<: *ollama
    build:
      context: ollama
      dockerfile: Dockerfile.nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  amd:
    profiles: ["amd"]
    <<: *ollama
    image: ghcr.io/devil666face/ollama:amd
    build:
      context: ollama
      dockerfile: Dockerfile.amd
    devices:
      - "/dev/kfd"
      - "/dev/dri"

  intel:
    profiles: ["intel"]
    <<: *ollama
    image: ghcr.io/devil666face/ollama:intel
    build:
      context: ollama
      dockerfile: Dockerfile.intel
    devices:
      - /dev/dri:/dev/dri
    environment:
      no_proxy: localhost,127.0.0.1
      OLLAMA_HOST: 0.0.0.0
      DEVICE: Arc
      OLLAMA_INTEL_GPU: true
      OLLAMA_NUM_GPU: 999
      ZES_ENABLE_SYSMAN: 1

networks:
  ailab:
    name: ailab
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/24
          gateway: 172.22.0.1
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.name: br-ailab
